graph TB
    %% External Components
    User["User"]
    S3Upload["S3 Uploads Bucket"]
    S3Encrypted["S3 Encrypted Bucket"]

    %% Core Services
    StoreL["Store Lambda Function"]
    RetrieveL["Retrieve Lambda Function"]
    DB[("PostgreSQL Database")]
    KMS["AWS KMS Service"]

    %% Event Flow
    S3Event["S3 Event Notification"]
    
    %% User Interactions
    User -->|Upload Document| S3Upload
    User -->|Request Decryption| RetrieveL

    %% Automatic Encryption Flow
    S3Upload -->|Triggers| S3Event
    S3Event -->|Invokes| StoreL
    StoreL -->|Get Active Key| DB
    StoreL -->|KMS Operations| KMS
    StoreL -->|Store Encrypted| S3Encrypted

    %% Decryption Flow
    RetrieveL -->|Get Private Key| DB
    RetrieveL -->|Download Package| S3Encrypted
    RetrieveL -->|Return Decrypted| User

    %% Database Operations
    StoreL -->|Log Operations| DB
    RetrieveL -->|Log Access| DB
    
    %% Algorithm Details
    subgraph Algo ["Encryption Algorithm"]
        direction LR
        Kyber["Kyber768 KEM<br/>Key Encapsulation"]
        AES["AES-256-CBC<br/>Data Encryption"]
        Kyber --> AES
    end

    StoreL -.->|Uses| Algo
    RetrieveL -.->|Uses| Algo

    %% Database Schema
    subgraph DBSchema ["Database Tables"]
        direction TB
        EncKeys["encryption_keys<br/>Stores key pairs"]
        AccessLogs["access_logs<br/>Audit trail"]
        KeyRotations["key_rotations<br/>Rotation management"]

        EncKeys -.-> AccessLogs
        EncKeys -.-> KeyRotations
    end

    DB -.->|Contains| DBSchema

    %% Security Features
    subgraph Security ["Security Features"]
        direction TB
        PQC["Post-Quantum<br/>Cryptography"]
        KeyRot["Automatic<br/>Key Rotation"]
        Audit["Comprehensive<br/>Audit Logging"]

        PQC --> KeyRot
        KeyRot --> Audit
    end
    
    %% Styling
    classDef userClass fill:#e1f5fe,stroke:#01579b,stroke-width:2px,font-size:14px,color:#000
    classDef lambdaClass fill:#fff3e0,stroke:#e65100,stroke-width:2px,font-size:14px,color:#000
    classDef storageClass fill:#f3e5f5,stroke:#4a148c,stroke-width:2px,font-size:14px,color:#000
    classDef eventClass fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px,font-size:14px,color:#000
    classDef algorithmClass fill:#fff8e1,stroke:#f57f17,stroke-width:2px,font-size:14px,color:#000
    classDef dbClass fill:#fce4ec,stroke:#880e4f,stroke-width:2px,font-size:14px,color:#000

    class User userClass
    class StoreL,RetrieveL lambdaClass
    class S3Upload,S3Encrypted storageClass
    class DB,KMS storageClass
    class S3Event eventClass
    class Kyber,AES algorithmClass
    class EncKeys,AccessLogs,KeyRotations dbClass
    class PQC,KeyRot,Audit eventClass
