graph TB
    %% External Components
    User["User"]
    S3Up["S3 Upload"]
    S3Enc["S3 Encrypt"]

    %% Core Services
    Store["Store"]
    Retrieve["Retrieve"]
    DB[("Database")]
    KMS["KMS"]

    %% Event Flow
    Event["Event"]
    
    %% User Interactions
    User --> S3Up
    User --> Retrieve

    %% Automatic Encryption Flow
    S3Up --> Event
    Event --> Store
    Store --> DB
    Store --> KMS
    Store --> S3Enc

    %% Decryption Flow
    Retrieve --> DB
    Retrieve --> S3Enc
    Retrieve --> User
    
    %% Algorithm Details
    subgraph Algo ["Crypto"]
        Kyber["Kyber"]
        AES["AES"]
        Kyber --> AES
    end

    Store -.-> Algo
    Retrieve -.-> Algo

    %% Database Schema
    subgraph DBSchema ["Tables"]
        Keys["Keys"]
        Logs["Logs"]
        Rots["Rotations"]

        Keys -.-> Logs
        Keys -.-> Rots
    end

    DB -.-> DBSchema
    
    %% Styling
    classDef userClass fill:#e1f5fe,stroke:none,font-size:12px,color:#000,min-width:80px
    classDef lambdaClass fill:#fff3e0,stroke:none,font-size:12px,color:#000,min-width:80px
    classDef storageClass fill:#f3e5f5,stroke:none,font-size:12px,color:#000,min-width:80px
    classDef eventClass fill:#e8f5e8,stroke:none,font-size:12px,color:#000,min-width:80px
    classDef algorithmClass fill:#fff8e1,stroke:none,font-size:12px,color:#000,min-width:80px
    classDef dbClass fill:#fce4ec,stroke:none,font-size:12px,color:#000,min-width:80px

    class User userClass
    class Store,Retrieve lambdaClass
    class S3Up,S3Enc storageClass
    class DB,KMS storageClass
    class Event eventClass
    class Kyber,AES algorithmClass
    class Keys,Logs,Rots dbClass
