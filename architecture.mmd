graph TB
    %% External Components
    User[üë§ User]
    S3Upload[üìÅ S3 uploads/]
    S3Encrypted[üîí S3 encrypted/]

    %% Core Services
    StoreL[‚ö° Store Lambda]
    RetrieveL[‚ö° Retrieve Lambda]
    DB[(üóÑÔ∏è PostgreSQL)]
    KMS[üîë AWS KMS]

    %% Event Flow
    S3Event[üì® S3 Event]
    
    %% User Interactions
    User -->|1. Upload Document| S3Upload
    User -->|6. Request Decryption| RetrieveL
    
    %% Automatic Encryption Flow
    S3Upload -->|2. Triggers| S3Event
    S3Event -->|3. Invokes| StoreL
    StoreL -->|4a. Get Active Key| DB
    StoreL -->|4b. KMS Operations| KMS
    StoreL -->|5. Store Encrypted| S3Encrypted
    
    %% Decryption Flow
    RetrieveL -->|7a. Get Private Key| DB
    RetrieveL -->|7b. Download Package| S3Encrypted
    RetrieveL -->|8. Return Decrypted| User
    
    %% Database Operations
    StoreL -->|Log Operations| DB
    RetrieveL -->|Log Access| DB
    
    %% Algorithm Details
    subgraph "üîê Encryption"
        direction TB
        Kyber[Kyber768 KEM]
        AES[AES-256-CBC]
        Kyber --> AES
    end
    
    StoreL -.->|Uses| Kyber
    RetrieveL -.->|Uses| AES
    
    %% Database Schema
    subgraph "üóÑÔ∏è Database"
        direction TB
        EncKeys[encryption_keys]
        AccessLogs[access_logs]
        KeyRotations[key_rotations]

        EncKeys -.-> AccessLogs
        EncKeys -.-> KeyRotations
    end
    
    DB -.-> EncKeys
    
    %% Security Features
    subgraph "üõ°Ô∏è Security Features"
        direction TB
        PQC[Post-Quantum<br/>Cryptography]
        KeyRot[Automatic<br/>Key Rotation]
        Audit[Comprehensive<br/>Audit Logging]
        
        PQC --> KeyRot
        KeyRot --> Audit
    end
    
    %% Styling
    classDef userClass fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef lambdaClass fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef storageClass fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef securityClass fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef algorithmClass fill:#fff8e1,stroke:#f57f17,stroke-width:2px
    
    class User userClass
    class StoreL,RetrieveL lambdaClass
    class S3Upload,S3Encrypted,DB storageClass
    class KMS,PQC,KeyRot,Audit securityClass
    class Kyber,AES algorithmClass
