%%{init: {"flowchart": {"htmlLabels": false}} }%%
graph TB
    %% External Components
    User["👤<br/>User"]
    S3Upload["📁<br/>S3 uploads"]
    S3Encrypted["🔒<br/>S3 encrypted"]

    %% Core Services
    StoreL["⚡<br/>Store Lambda"]
    RetrieveL["⚡<br/>Retrieve Lambda"]
    DB[("🗄️<br/>PostgreSQL")]
    KMS["🔑<br/>AWS KMS"]

    %% Event Flow
    S3Event["📨<br/>S3 Event"]
    
    %% User Interactions
    User -->|1. Upload Document| S3Upload
    User -->|6. Request Decryption| RetrieveL
    
    %% Automatic Encryption Flow
    S3Upload -->|2. Triggers| S3Event
    S3Event -->|3. Invokes| StoreL
    StoreL -->|4a. Get Active Key| DB
    StoreL -->|4b. KMS Operations| KMS
    StoreL -->|5. Store Encrypted| S3Encrypted
    
    %% Decryption Flow
    RetrieveL -->|7a. Get Private Key| DB
    RetrieveL -->|7b. Download Package| S3Encrypted
    RetrieveL -->|8. Return Decrypted| User
    
    %% Database Operations
    StoreL -->|Log Operations| DB
    RetrieveL -->|Log Access| DB
    
    %% Algorithm Details
    subgraph Algo ["🔐 Encryption"]
        direction LR
        Kyber["Kyber768<br/>KEM"]
        AES["AES-256<br/>CBC"]
        Kyber --> AES
    end

    StoreL -.-> Algo
    RetrieveL -.-> Algo

    %% Database Schema
    subgraph DBSchema ["🗄️ Database Tables"]
        direction LR
        EncKeys["encryption_keys"]
        AccessLogs["access_logs"]
        KeyRotations["key_rotations"]

        EncKeys -.-> AccessLogs
        EncKeys -.-> KeyRotations
    end

    DB -.-> DBSchema

    %% Security Features
    subgraph Security ["🛡️ Security Features"]
        direction LR
        PQC["Post-Quantum<br/>Crypto"]
        KeyRot["Key<br/>Rotation"]
        Audit["Audit<br/>Logging"]

        PQC --> KeyRot
        KeyRot --> Audit
    end
    
    %% Styling
    classDef userClass fill:#e1f5fe,stroke:#01579b,stroke-width:2px,font-size:12px
    classDef lambdaClass fill:#fff3e0,stroke:#e65100,stroke-width:2px,font-size:12px
    classDef storageClass fill:#f3e5f5,stroke:#4a148c,stroke-width:2px,font-size:12px
    classDef securityClass fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px,font-size:12px
    classDef algorithmClass fill:#fff8e1,stroke:#f57f17,stroke-width:2px,font-size:12px
    classDef subgraphClass fill:#f9f9f9,stroke:#666,stroke-width:1px

    class User userClass
    class StoreL,RetrieveL lambdaClass
    class S3Upload,S3Encrypted,DB storageClass
    class KMS,PQC,KeyRot,Audit securityClass
    class Kyber,AES,EncKeys,AccessLogs,KeyRotations algorithmClass
